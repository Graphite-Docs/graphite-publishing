/**
 * yjs - A framework for real-time p2p shared editing on any data
 * @version v12.1.3
 * @link http://y-js.org
 * @license MIT
 */
!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.yRichtext=t()}}(function(){return function t(e,n,r){function i(l,s){if(!n[l]){if(!e[l]){var a="function"==typeof require&&require;if(!s&&a)return a(l,!0);if(o)return o(l,!0);var u=new Error("Cannot find module '"+l+"'");throw u.code="MODULE_NOT_FOUND",u}var c=n[l]={exports:{}};e[l][0].call(c.exports,function(t){var n=e[l][1][t];return i(n?n:t)},c,c.exports,t,e,n,r)}return n[l].exports}for(var o="function"==typeof require&&require,l=0;l<r.length;l++)i(r[l]);return i}({1:[function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function l(t){function e(t,e){return t===e||null==t&&null==e||null!=t&&null!=e&&t.constructor===Array&&t[0]===e[0]&&t[1]===e[1]}t.requestModules(["Array"]).then(function(){var n=function(n){function l(t,e,n){r(this,l);var o=i(this,Object.getPrototypeOf(l).call(this,t,e,n));return o.instances=[],o.eventHandler._pullChanges=function(){o.instances.forEach(function(t){t.editor.update()})},o._quillBlockFormats=["blockquote","header","indent","list","align","direction","code-block"],o}return o(l,n),s(l,[{key:"_sanitizeOpAttributes",value:function(t){if(null==t||0===Object.keys(t).length)return null;var e={};for(var n in t)this._quillBlockFormats.some(function(t){return t===n})?e._block=[n,t[n]]:e[n]=t[n];return e}},{key:"_formatAttributesForQuill",value:function(t){var e={};for(var n in t){var r=t[n];"_block"===n?r&&(e[t[n][0]]=t[n][1]):e[n]=r}return e}},{key:"_destroy",value:function(){this.unbindQuillAll(),a(Object.getPrototypeOf(l.prototype),"_destroy",this).call(this)}},{key:"toString",value:function(){return this._content.map(function(t){if("string"==typeof t.val)return t.val}).join("")}},{key:"toDelta",value:function(){function t(){var t={};for(var e in l.attributes)t[e]=l.attributes[e];l={insert:[],attributes:t}}for(var e=this,n=!1,r=this._content.length-1;r>=0;r--){var i=this._content[r];if(i.val.constructor!==Array){"\n"===i.val&&(n=!0);break}}n||this.push("\n");var o=[],l={insert:[],attributes:{}};for(r=0;r<this._content.length;r++){var s=this._content[r].val;if(s.constructor===Array){if(!l.attributes.hasOwnProperty(s[0])&&null==s[1]||l.attributes[s[0]]===s[1])continue;l.insert.length>0&&(l.insert=l.insert.join(""),o.push(l),t()),null===s[1]?delete l.attributes[s[0]]:l.attributes[s[0]]=s[1]}else"string"==typeof s?l.insert.push(s):(l.insert.length>0&&(l.insert=l.insert.join(""),o.push(l),t()),l.insert=s,o.push(l),t())}return l.insert.length>0&&(l.insert=l.insert.join(""),o.push(l)),o.forEach(function(t){0===Object.keys(t.attributes).length?delete t.attributes:t.attributes=e._formatAttributesForQuill(t.attributes)}),o}},{key:"insert",value:function(t,e){for(var n=0,r={},i=0;i<this._content.length&&n!==t;i++){var o=this._content[i].val;o.constructor!==Array?n++:null===o[1]?delete r[o[0]]:r[o[0]]=o[1]}var s;return s="string"==typeof e?e.split(""):e.constructor===Object?[e]:e,a(Object.getPrototypeOf(l.prototype),"insert",this).call(this,i,s),r}},{key:"delete",value:function(t,n){var r=0,i={},o=t+n;if(!(n<=0)){var s,u,c,f;for(s=0;r<t&&s<this._content.length;s++)c=this._content[s].val,c.constructor!==Array?r++:i[c[0]]=c[1];for(u=s;r<o&&u<this._content.length;u++)c=this._content[u].val,c.constructor!==Array&&r++;if(u===this._content.length)a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,s,u-s);else{c.constructor!==Array&&u--;var h={};for(f=u;f>=s;f--)if(c=this._content[f].val,c.constructor===Array)void 0===h[c[0]]?(e(c[1],i[c[0]])&&a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,f,1),h[c[0]]=c[1]):a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,f,1);else{for(var p=f+1;f>s&&(c=this._content[f-1].val,c.constructor!==Array);)f--;a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,f,p-f)}}}}},{key:"select",value:function(t,n,r,i){if(null==t||null==n||null==r||void 0===i)throw new Error("You must define four parameters");for(var o,s,u=[r,null],c=0,f=0;f<this._content.length&&c!==t;f++){var h=this._content[f].val;h.constructor===Array?h[0]===r&&(u[1]=h[1]):c++}e(u[1],i)||(o=f,s=[r,i]);for(var p=[];f<this._content.length&&c!==n;f++){var v=this._content[f].val;v.constructor===Array?v[0]===r&&(u[1]=v[1],p.push(f)):c++}for(var y=p.length-1;y>=0;y--){var d=p[y];a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,d,1),d<f&&f--,d<o&&o--}if(!e(u[1],i)&&f<this._content.length){var b,g=!0;for(y=f;y<this._content.length&&(b=this._content[y].val,b.constructor===Array);y++)if(b[0]===r){g=!1,e(b[1],i)&&a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,y,1);break}if(g){var _=[r,u[1]];a(Object.getPrototypeOf(l.prototype),"insert",this).call(this,f,[_])}}if(null!=o)for(a(Object.getPrototypeOf(l.prototype),"insert",this).call(this,o,[s]),y=o-1;y>=0&&(b=this._content[y].val,b.constructor===Array);y--)b[0]===r&&a(Object.getPrototypeOf(l.prototype),"delete",this).call(this,y,1)}},{key:"applyDelta",value:function(t,n){for(var r,i=0,o=0;o<t.ops.length;o++){var l,s,a=t.ops[o],u=this._sanitizeOpAttributes(a.attributes);if(null!=a.insert){"string"==typeof a.insert?(l=this.insert(i,a.insert),s=a.insert.length):(l=this.insert(i,a.insert),s=1);for(r in u)e(u[r],l[r])||this.select(i,i+s,r,u[r]);for(r in l)null!=u&&null!=u[r]||this.select(i,i+s,r,null);i+=s}if(null!=a.delete&&this.delete(i,a.delete),null!=a.retain&&null!=n){var c=i+a.retain;if(c>this.length){var f=n.getText(this.length);n.insertText(this.length,f);for(r in u){var h={};h[r]=!1,h=this._formatAttributesForQuill(h),n.formatText(this.length+f.length,f.length,h)}this.insert(this.length,f)}for(r in u){var p=u[r];this.select(i,c,r,p)}i=c}}}},{key:"bind",value:function(){this.bindQuill.apply(this,arguments)}},{key:"unbindQuillAll",value:function(){for(var t=this.instances.length-1;t>=0;t--)this.unbindQuill(this.instances[t].editor)}},{key:"unbindQuill",value:function(t){var e=this.instances.findIndex(function(e){return e.editor===t});if(e>=0){var n=this.instances[e];n.editor.yRichtextBinding=null,this.unobserve(n.yCallback),n.editor.off("text-change",n.quillCallback),this.instances.splice(e,1)}}},{key:"bindQuill",value:function(n){function r(t){if(s){s=!1;try{t()}catch(t){throw n.update(),s=!0,new Error(t)}n.update(),s=!0}}function i(t){r(function(){l.applyDelta(t,n)})}function o(i){r(function(){var r,o;if("insert"===i.type)for(var s=0;s<i.values.length;){for(var a=[];s<i.values.length&&i.values[s].constructor!==Array;)a.push(i.values[s]),s++;if(a.length>0){for(var u=0,c={},f=0;f<i.index;f++)r=l._content[f].val,r.constructor!==Array?u++:c[r[0]]=r[1];for(f=i.index+i.length;f<l._content.length&&(r=l._content[f].val,r.constructor===Array);)c.hasOwnProperty(r[0])||(c[r[0]]=null),f++;for(var h in c)null==c[h]&&(c[h]=!1);if(l.length===u+a.length&&"\n"!==a[a.length-1]){var p=["\n"],v={};for(h in c)c[h]!==!1&&(p.unshift([h,!1]),v[h]=!1);t.Array.typeDefinition.class.prototype.insert.call(l,u+a.length,p),n.insertText(u,"\n",l._formatAttributesForQuill(v))}var y=[];u>0&&y.push({retain:u});var d=[];a.forEach(function(t){"string"==typeof t?d.push(t):(d.length>0&&(y.push({insert:d.join(""),attributes:c}),d=[]),y.push({insert:t,attributes:c}))}),d.length>0&&y.push({insert:d.join(""),attributes:c}),y.forEach(function(t){null!=t.attributes&&Object.keys(t.attributes).length>0?t.attributes=l._formatAttributesForQuill(t.attributes):delete t.attributes}),n.updateContents(y)}else{o=null;for(var b=i.values[s++],g=0,_=i.index+s-2;_>=0;_--)if(r=l._content[_].val,r.constructor===Array){if(b[0]===r[0]){o=r[1];break}}else g++;for(;_>=0;_--)r=l._content[_].val,r.constructor!==Array&&g++;if(e(b[1],o))continue;for(var x=g,O=i.index+s;O<l._content.length;O++)if(r=l._content[O].val,r.constructor===Array){if(r[0]===b[0])break}else x++;if(g!==x){var k={};if(k[b[0]]=null!=b[1]&&b[1],k=l._formatAttributesForQuill(k),"_block"===b[0]){var A={};l._quillBlockFormats.forEach(function(t){A[t]=!1}),n.formatText(g,x-g,A)}n.formatText(g,x-g,k)}}}else if("delete"===i.type){for(var m=[],j=0,w=0;j<i.length;j++)i.values[j].constructor===Array&&(j!==w&&m.push({type:"text",length:j-w,index:i.index}),w=j+1,m.push({type:"selection",val:i.values[j],index:i.index}));j!==w&&m.push({type:"text",length:j-w,index:i.index}),m.forEach(function(t){if("text"===t.type){for(var i=0,s=0;s<t.index;s++)r=l._content[s].val,r.constructor!==Array&&i++;n.deleteText(i,t.length)}else{o=null;var a,u=0;for(a=t.index-1;a>=0;a--)if(r=l._content[a].val,r.constructor===Array){if(r[0]===t.val[0]){o=r[1];break}}else u++;for(;a>=0;a--)r=l._content[a].val,r.constructor!==Array&&u++;var c=u;for(a=t.index;a<l._content.length;a++)if(r=l._content[a].val,r.constructor===Array){if(r[0]===t.val[0])break}else c++;if(!e(o,t.val[1])&&u!==c){var f={};if(f[t.val[0]]=null!=o&&o,f=l._formatAttributesForQuill(f),"_block"===t.val[0]){var h={};l._quillBlockFormats.forEach(function(t){h[t]=!1}),n.formatText(u,c-u,h)}n.formatText(u,c-u,f)}}})}n.update()})}var l=this,s=!0;null!=n.yRichtextBinding&&n.yRichtextBinding.unbindQuill(n),n.setContents(this.toDelta()),n.update(),n.on("text-change",i),this.observe(o),this.instances.push({editor:n,yCallback:o,quillCallback:i}),n.yRichtextBinding=this}},{key:"length",get:function(){return this.toString().length}}]),l}(t.Array.typeDefinition.class);t.extend("Richtext",new t.utils.CustomTypeDefinition({name:"Richtext",class:n,struct:"List",initType:regeneratorRuntime.mark(function e(r,i){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=[],e.delegateYield(t.Struct.List.map.call(this,i,function(t){if(t.hasOwnProperty("opContent"))throw new Error("Text must not contain types!");t.content.forEach(function(e,n){o.push({id:[t.id[0],t.id[1]+n],val:t.content[n]})})}),"t0",2);case 2:return e.abrupt("return",new n(r,i.id,o));case 3:case"end":return e.stop()}},e,this)}),createType:function(t,e){return new n(t,e.id,[])}}))})}var s=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),a=function t(e,n,r){null===e&&(e=Function.prototype);var i=Object.getOwnPropertyDescriptor(e,n);if(void 0===i){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,n,r)}if("value"in i)return i.value;var l=i.get;if(void 0!==l)return l.call(r)};e.exports=l,"undefined"!=typeof Y&&l(Y)},{}]},{},[1])(1)});
//# sourceMappingURL=y-richtext.js.map
